<html>
    <head>
        <title>Fierce Planet</title>
        <base href="/">
        <link rel="stylesheet" type="text/css" href="../css/fp.css">
        <script src="../js/require.js"></script>
        <script>
        requirejs.config({
            baseUrl: '../js',
            "shim": {
                "underscore": { exports: "_" },
                "dat.gui": { exports: "dat.gui" },
                "smoothie": { exports: "SmoothieChart" },
                "stats.min": { exports: "Stats" },
                "jstat.min": { exports: "jStat" },
                "three": { exports: "THREE" },
                "Mirror": ["three"],
                "WaterShader": ["three"],
                "TerrainLoader": { deps: ["three"], exports: "TerrainLoader" },
                "TrackballControls": {  deps: ["three"], exports: "TrackballControls" },
                "OrbitControls": {  deps: ["three"], exports: "OrbitControls" },
                "PointerLockControls": {  deps: ["three"], exports: "PointerLockControls" },
            }
        })
        requirejs([
                "fp",
                "dat.gui",
                "smoothie",
                "stats.min",
                "jstat.min",
                "javascript.util",
                "jsts",
                "Mirror",
                "WaterShader",
                "TerrainLoader",
                "THREEx.KeyboardState",
                "TrackballControls",
                "PointerLockControls",
            ],
            function() {
                var config = {
                  "preset": "Default",
                  "remembered": {
                    "Default": {
                        // Agent options
                        "1": {
                            "initialPopulation": 20,
                            "initialExtent": 10,
                            // "maxExtent": 100,
                            // "initialX": 50,
                            // "initialY": 50,
                            // "randomAge": true,
                            "chanceToJoinNetwork": 0.01,
                            "chanceToJoinNetworkWithHome": 0.25,
                            "chanceToJoinNetworkWithBothHomes": 0.5,
                            "chanceToFindPathToHome": 0.01,
                            "chanceToFindPathToOtherAgentHome": 0.01,
                            // "initialCircle": true,
                            // "noWater": true,
                            // "noUphill": false,
                            // "useStickman": true,
                            // "visitHomeBuilding": 0.02,
                            // "visitOtherBuilding": 0.002,
                            "establishLinks": true,
                            // "size": 40,
                            // "terrainOffset": 20,
                            "shuffle": true
                         },
                        // Building options
                        "2": {
                            "roads": 0.0,
                            "water": 0.0,
                            "otherBuildings": 0.25,
                            "distanceFromOtherBuildingsMin": 5000,
                            "distanceFromOtherBuildingsMax": 5500,
                            "buildingHeight": 0.0,
                            "detectBuildingCollisions": true,

                            "create": false,

                            // "maxNumber": 250,

                            // // Carry over from generation
                            // "heightA": 2,
                            // "heightB": 10,

                            // // Influences

                            // // Building form
                            // "buildingForm": "rectangle",
                            // "spread": 10,
                            // "randomForm": false,
                            // "rotateRandomly": false,
                            // "rotateSetAngle": 0,

                            // "destroyOnComplete": false,
                            // "loopCreateDestroy": false,

                            // // Visualisation
                            // "turning": false,
                            // "falling": false,
                            "riseRate": 1,

                            // // Dimensions
                            "minHeight": 10,
                            "maxHeight": 70,
                            // "minWidth": 40,
                            // "maxWidth": 200,
                            // "minLength": 40,
                            // "maxLength": 200,
                            // "maxLevels": 0,
                            // "maxLevels": 0,
                            // "width": 0,
                            // "length": 0,
                            // "levelHeight": 40,

                            // // View parameters
                            // "useShader": true,
                            // "useLevelOfDetail": true,
                            // "highResDistance": 1000,
                            // "lowResDistance": 7500,
                            // "opacity": 1.0,

                            // // Fill parameters
                            // "showFill": true,
                            // "fillRooves": false,

                            // // Stroke parameters
                            // "showLines": true,
                            // "linewidth": 1.0,

                            // // Window parameters
                            // "showWindows": true,
                            // "windowsRandomise": false,
                            // "windowWidth": 15,
                            // "windowPercent": 60,
                            // "windowsStartY": 40,
                            // "windowsEndY": 80,
                            // "windowsLine": true,
                            // "windowsFill": false,

                            // // Stagger
                            // "stagger": true,
                            // "staggerAmount": 40,

                            // // Taper
                            // "taper": true,
                            // "taperExponent": 2,
                            // "taperDistribution": 1,

                            // // Collision detection
                            // "detectBuildingCollisions": true,
                            // "detectRoadCollisions": true

                        },
                        // Road options
                        "3": {
                            "create": false

                            // "maxNumber": 200,  // Maximum number of roads - for performance reasons
                            // "roadWidth": 20,
                            // "roadDeviation": 20,
                            // "roadRadiusSegments": 10,
                            // "roadSegments": 10,
                            // "initialRadius": 100,
                            // "probability": 1,
                            // "lenMinimum": 100,
                            // "lenMaximum": 2000,
                            // "lenDistributionFactor": 3,
                            // "overlapThreshold": 3,
                            // "flattenAdjustment": 0.025,
                            // "flattenLift": 20
                        },
                        // Display options
                        "4": {
                            // "agentsShow": true,
                            "buildingsShow": true,
                            // "roadsShow": true,
                            "waterShow": false,
                            "networkShow": false,
                            "networkCurve": false,
                            // "networkCurvePoints": 20,
                            "patchesShow": false,
                            "patchesUpdate": true,
                            // "patchesUseShader": false,
                            // "trailsShow": false,
                            // "trailsShowAsLines": false,
                            // "trailLength": 10000,
                            // "cursorShow": false,
                            // "cursorShowCell": true,
                            // "statsShow": true,
                            // "hudShow": true,
                            // "wireframeShow": false,
                            // "dayShow": false,
                            // "skyboxShow": true,
                            // "chartShow": true,
                            // "guiShow": true,
                            // "guiShowControls": true,
                            // "guiShowAgentFolder": true,
                            // "guiShowBuildingsFolder": true,
                            // "guiShowRoadsFolder": true,
                            // "guiShowTerrainFolder": true,
                            // "guiShowDisplayFolder": true,
                            // "guiShowColorFolder": true,
                            // "pathsShow": true,
                            "terrainShow": false,
                            // "coloriseAgentsByHealth": false,
                            // "firstPersonView": false,
                            "cameraOverride": true,
                            "cameraX": 0,
                            "cameraY": 500,
                            "cameraZ": 2250,
                            // "maximiseView": true,
                        },
                        // Color options
                        "5": {
                            // "colorDayBackground": 0x000000,
                            // "colorDayRoad": 0x474747,
                            // "colorDayAgent": 0x4747b3,
                            // "colorDayNetwork": 0x474747,
                            // "colorDayTrail": 0x474747,
                            // "colorDayPath": 0x474747,
                            // "colorDayBuildingFill": 0xb1abab,
                            // "colorDayBuildingLine": 0x222222,
                            // "colorDayBuildingWindow": 0x222222,
                            // "colorDayTerrainSea": 0x969696,
                            // "colorDayTerrainLowland1": 0x2d5828,
                            // "colorDayTerrainLowland2": 0x6d915b,
                            // "colorDayTerrainMidland": 0x89450e,
                            // "colorDayTerrainHighland": 0x8c8c8c,

                            "colorNightBackground": 0x030303,
                            "colorNightRoad": 32 * 256 * 256 + 32 * 256 + 32,
                            "colorNightAgent": 0xffffff,
                            "colorNightNetwork": 0xffffff,
                            // "colorNightTrail": 0x47b347,
                            "colorNightPath": 0xffffff,
                            "colorNightBuildingFill": 0xd3d3d3,
                            // "colorNightBuildingLine": 0x838383,
                            "colorNightBuildingWindow": 0xffffff,
                            // "colorNightTerrainSea": 0x000000,
                            "colorNightTerrainLowland1": 0x000000,
                            "colorNightTerrainLowland2": 0x040404,
                            "colorNightTerrainMidland": 0x080808,
                            "colorNightTerrainHighland": 0x0c0c0c,
                            // "colorGraphPopulation": 0x4747b3,
                            // "colorGraphHealth": 0xb34747,
                            // "colorGraphPatchValues": 0x47b347,
                            //
                            "colorLightHemisphereSky": 0xbfbfbf,
                            "colorLightHemisphereGround": 0xbfbfbf,
                            "colorLightHemisphereIntensity": 1.0,
                            "colorLightDirectional": 0xffffff,
                            "colorLightDirectionalIntensity": 1.0,

                        },
                        // Terrain options
                        "6": {
                            // "renderAsSphere": true,
                            "loadHeights": true ,
                            "gridExtent": 8000,
                            "gridPoints": 400, // Must be odd!
                            "maxTerrainHeight": 400,
                            // "shaderUse": true,
                            "multiplier": 1,
                            // "mapIndex": 0,
                            "patchSize": 21

                         },
                    }
                  }
                };
                var GeoLanguageAgent = function() {
                    fp.Agent.call( this );
                    this.lexicon = 0.0;
                    this.origState = null;
                    this.spokenState = null;
                    this.age = 20 + Math.floor( Math.random() * 20 );
                    this.sex = Math.floor( Math.random() * 2 );
                    this.ticksSinceReproduction = 0;
                    this.motherNode = null;
                    this.wordList = _.range( 10 ).map( function () { return 0.0 } );



                    // Set up an agent class that can exercise, consume, reproduce and die
                    this.exercise = function() {
                        if (this.health > 0)
                            this.health -= fp.appConfig.malthusOptions.energyLoss;
                    }

                    this.consume = function() {
                        var index = fp.getPatchIndex( this.position.x, this.position.z );
                        var patch = fp.patchNetwork.patches[index];
                        if ( !_.isUndefined( patch ) ) {
                            var agentsOnPatch = patch.length;
                            var patchValue = fp.patchNetwork.patchValues[index];
                            var availableYield = patchValue.value / agentsOnPatch;
                            patchValue.updatePatchValue( - fp.appConfig.malthusOptions.patchConsumptionRate );
                            this.health += fp.appConfig.malthusOptions.energyGain * availableYield;
                            this.health = (this.health > 100) ? 100 : this.health;
                        }
                    };

                    this.die = function() {
                        fp.scene.remove( fp.agentNetwork.particles );
                        var index = fp.agentNetwork.agents.indexOf(this);
                        fp.agentNetwork.agents.splice(index, 1);
                        fp.agentNetwork.updateAgentParticleSystem();
                        fp.scene.add( fp.agentNetwork.particles );
                    };

                    this.reproduce = function() {
                        // Crude set of assumptions about conditions for reproduction
                        var current = fp.agentNetwork.agents.length;
                        var initial = fp.appConfig.agentOptions.initialPopulation;
                        var popCorrection = Math.pow( ( current / initial ), 2 );
                        if ( Math.random() * popCorrection <  fp.appConfig.malthusOptions.reproductionChance &&
                             this.children.length < fp.appConfig.malthusOptions.maxChildren &&
                             this.gender == "f" &&
                             Math.random() * this.health > 50 &&
                             this.age > 15 && this.age < 50 )  {
                            fp.scene.remove( fp.agentNetwork.particles );
                            var agent = fp.agentNetwork.createAgent();
                            agent.mother = this;
                            agent.color = this.color;
                            this.children.push(agent);
                            fp.agentNetwork.agents.push(agent);
                            fp.agentNetwork.updateAgentParticleSystem();
                        }
                    };

                };
                GeoLanguageAgent.prototype = Object.create( fp.Agent.prototype );

                // Override PatchNetwork methods
                fp.PatchNetwork.prototype.elev;
                fp.PatchNetwork.prototype.attractiveness;
                fp.PatchNetwork.prototype.reviseValues = function() {
                    fp.patchNetwork.patchMeanValue = 0;
                    for (var i = 0; i < fp.patchNetwork.patchValues.length; i++) {
                        var patch = fp.patchNetwork.patchValues[i];
                        // if ( _.isUndefined( fp.patchNetwork.patches[i] ) && patch.value < patch.initialValue ) { // Recover
                        if ( patch.value < patch.initialValue ) { // Recover
                            patch.updatePatchValue( fp.appConfig.malthusOptions.patchRecoveryRate );
                        }
                        fp.patchNetwork.patchMeanValue += patch.value;
                    }
                    fp.patchNetwork.patchMeanValue /= fp.patchNetwork.patchValues.length;
                };


                var sim =  {
                    counter: 0,
                    positions: [],


                    report: function() {
                        if (agents.length > 0)
                        {
                            LanguageChange.aveLanguageChange = jStat.mean(_.map(agents, function(a) { return a.lexicon; }       ));
                            if (LanguageChange.aveLanguageChange != LanguageChange.prevAveLanguageChange)
                                console.log(LanguageChange.aveLanguageChange)
                            LanguageChange.prevAveLanguageChange = LanguageChange.aveLanguageChange;
                        }
                    },

                    updateAgentColor: function( agent ) {
                        agent.color = 'rgb(' + Math.floor(256 * (1.0 - agent.lexicon)) + ', 0, ' + Math.floor(256 * agent.lexicon) + ')';
                    },

                    distributeGrammars: function() {
                        var sim = this;
                        fp.agentNetwork.agents.forEach(function(agent) {
                            var chance = Math.random();
                            if (chance > fp.appConfig.geoGamesOptions.percentageLanguage1 )
                                agent.lexicon = 0.0;
                            else
                                agent.lexicon = 1.0;
                            agent.originalState = agent.lexicon;
                            agent.spokenState = agent.lexicon;
                            agent.wordList = _.range(10).map(function () { return agent.originalState });
                            sim.updateAgentColor(agent)
                        });

                        // the next bit deals with making one node William Marsters so he can not change his lexicon and be historically accurate with age at death
                        var agentsWithOne = _.select(fp.agentNetwork.agents, function( a ) { return a.lexicon == 1.0 } );
                        var index = Math.floor( Math.random() * agentsWithOne.length );
                        // For debugging: fp.sim.marsters
                        this.marsters = agentsWithOne[ index ];
                        agentsWithOne[ index ].age = 40;

                        fp.agentNetwork.updateAgentShader();

                        // Shorthand to count agent lexicons
                        //_.reduce(_.map(fp.agentNetwork.agents, function(a){return a.lexicon}), function(memo, num) {return num + memo;}, 0);
                    },

                    redistribute: function() {
                        LanguageChange.distributeGrammars();
                    },

                    setup: function() {
                        fp.timescale.framesToYear = 16;

                        this.marsters = null;
                        this.elevation = null;
                        this.slope = null;
                        this.aspect = null;

                        this.distributeGrammars();
                        fp.appConfig.displayOptions.patchesShow = true;
                        fp.patchNetwork.togglePatchesStateWithShader();


                        /*
                        fp.agentNetwork.agents.forEach( function( agent ) {
                            // Set up a random age
                            if ( fp.appConfig.agentOptions.randomAge ) {
                                // Sample a beta distribution with alpha = 2 and beta = 5
                                // This produces a large population at roughly a reproductive age.
                                agent.age = Math.floor( jStat.beta.sample( 2, 5 ) * 100 );
                                agent.health = 100 - agent.age;
                            }
                        });
*/
                    },
                    tick: function() {
                        /*
                        if ( fp.timescale.frameCounter % 500 == 0  ) {
                            for ( var i = 0; i < this.positions.length; i++ ) {
                                var pos = this.positions[ i ];
                                var x = pos[ 0 ];
                                var y = pos[ 1 ];
                                var z = pos[ 2 ];
                                fp.camera.position.x = x;
                                fp.camera.position.y = y;
                                fp.camera.position.z = z;

                                var mimetype = mimetype  || "image/png";
                                var url = fp.renderer.domElement.toDataURL( mimetype );
                                var anchor = $( "<img>" ).attr( "src", url );
                                anchor.attr( "src", url )
                                anchor.attr( "id",  "img-" + fp.timescale.frameCounter + "-" + i )
                                $( "#links" ).append( anchor );
                                console.log( fp.timescale.frameCounter );
                            }
                        }
                        if ( fp.timescale.frameCounter > 10000 ) {
                            fp.appConfig.Setup();
                        }
                        */
                    }
                }

                fp.init( config, sim, function() {
                    // Set up custom parameters
                    fp.appConfig.geoGamesOptions = {};
                    fp.appConfig.geoGamesOptions.percentageLanguage1 = 0.4;
                    fp.appConfig.geoGamesOptions.rate = 0.3;
                    fp.appConfig.geoGamesOptions.childrensLanguage = 1;
                    fp.appConfig.geoGamesOptions.historicallyAccurage = true;
                    fp.appConfig.geoGamesOptions.marstersDoesntChange = false;
                    fp.appConfig.geoGamesOptions.reproductionRate = true;
                    fp.appConfig.geoGamesOptions.languageSplitByGender = true;
                    fp.appConfig.geoGamesOptions.leavingRate = 0.15;
                    fp.appConfig.geoGamesOptions.ticksPerYear = 100;
                    var geoLangGamesFolder = fp.gui.addFolder( "GeoLang Games Options" );
                    geoLangGamesFolder.add( fp.appConfig.geoGamesOptions, "percentageLanguage1", 0, 1).step( 0.01 );
                    geoLangGamesFolder.add( fp.appConfig.geoGamesOptions, "rate", 0, 1).step( 0.01 );
                    geoLangGamesFolder.add( fp.appConfig.geoGamesOptions, "childrensLanguage", 1, 3).step( 1 );
                    geoLangGamesFolder.add( fp.appConfig.geoGamesOptions, "historicallyAccurage");
                    geoLangGamesFolder.add( fp.appConfig.geoGamesOptions, "marstersDoesntChange");
                    geoLangGamesFolder.add( fp.appConfig.geoGamesOptions, "reproductionRate");
                    geoLangGamesFolder.add( fp.appConfig.geoGamesOptions, "languageSplitByGender");
                    geoLangGamesFolder.add( fp.appConfig.geoGamesOptions, "leavingRate", 0, 0.3).step( 0.01 );
                    geoLangGamesFolder.add( fp.appConfig.geoGamesOptions, "ticksPerYear", 1, 1000).step( 1 );

                    // Add custom class
                    fp.agentNetwork.agentClass = GeoLanguageAgent;
                    fp.patchNetwork.initialisePatchFunction = function() { return Math.random(); };
                    // fp.patchNetwork.initialisePatchFunction = function() { return 0.5; };

                    fp.appConfig.Setup();
                } );
            }
        );

        </script>
    </head>
    <body>
        <div id="container"></div>
        <div id="links"></div>
    </body>
</html>
