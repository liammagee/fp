<html>
    <head>
        <title>Fierce Planet</title>
        <link rel="stylesheet" type="text/css" href="/css/fp.css">
        <script src="data:application/octet-stream;base64,LyoNCiBSZXF1aXJlSlMgMi4xLjExIENvcHlyaWdodCAoYykgMjAxMC0yMDE0LCBUaGUgRG9qbyBGb3VuZGF0aW9uIEFsbCBSaWdodHMgUmVzZXJ2ZWQuDQogQXZhaWxhYmxlIHZpYSB0aGUgTUlUIG9yIG5ldyBCU0QgbGljZW5zZS4NCiBzZWU6IGh0dHA6Ly9naXRodWIuY29tL2pyYnVya2UvcmVxdWlyZWpzIGZvciBkZXRhaWxzDQoqLw0KdmFyIHJlcXVpcmVqcyxyZXF1aXJlLGRlZmluZTsNCihmdW5jdGlvbihjYSl7ZnVuY3Rpb24gRyhiKXtyZXR1cm4iW29iamVjdCBGdW5jdGlvbl0iPT09TS5jYWxsKGIpfWZ1bmN0aW9uIEgoYil7cmV0dXJuIltvYmplY3QgQXJyYXldIj09PU0uY2FsbChiKX1mdW5jdGlvbiB2KGIsYyl7aWYoYil7dmFyIGQ7Zm9yKGQ9MDtkPGIubGVuZ3RoJiYoIWJbZF18fCFjKGJbZF0sZCxiKSk7ZCs9MSk7fX1mdW5jdGlvbiBVKGIsYyl7aWYoYil7dmFyIGQ7Zm9yKGQ9Yi5sZW5ndGgtMTstMTxkJiYoIWJbZF18fCFjKGJbZF0sZCxiKSk7ZC09MSk7fX1mdW5jdGlvbiBzKGIsYyl7cmV0dXJuIGdhLmNhbGwoYixjKX1mdW5jdGlvbiBqKGIsYyl7cmV0dXJuIHMoYixjKSYmYltjXX1mdW5jdGlvbiBCKGIsYyl7Zm9yKHZhciBkIGluIGIpaWYocyhiLGQpJiZjKGJbZF0sZCkpYnJlYWt9ZnVuY3Rpb24gVihiLGMsZCxnKXtjJiZCKGMsZnVuY3Rpb24oYyxoKXtpZihkfHwhcyhiLGgpKWcmJiJvYmplY3QiPT09dHlwZW9mIGMmJmMmJiFIKGMpJiYhRyhjKSYmIShjIGluc3RhbmNlb2YNClJlZ0V4cCk/KGJbaF18fChiW2hdPXt9KSxWKGJbaF0sYyxkLGcpKTpiW2hdPWN9KTtyZXR1cm4gYn1mdW5jdGlvbiB0KGIsYyl7cmV0dXJuIGZ1bmN0aW9uKCl7cmV0dXJuIGMuYXBwbHkoYixhcmd1bWVudHMpfX1mdW5jdGlvbiBkYShiKXt0aHJvdyBiO31mdW5jdGlvbiBlYShiKXtpZighYilyZXR1cm4gYjt2YXIgYz1jYTt2KGIuc3BsaXQoIi4iKSxmdW5jdGlvbihiKXtjPWNbYl19KTtyZXR1cm4gY31mdW5jdGlvbiBDKGIsYyxkLGcpe2M9RXJyb3IoYysiXG5odHRwOi8vcmVxdWlyZWpzLm9yZy9kb2NzL2Vycm9ycy5odG1sIyIrYik7Yy5yZXF1aXJlVHlwZT1iO2MucmVxdWlyZU1vZHVsZXM9ZztkJiYoYy5vcmlnaW5hbEVycm9yPWQpO3JldHVybiBjfWZ1bmN0aW9uIGhhKGIpe2Z1bmN0aW9uIGMoYSxlLGIpe3ZhciBmLG4sYyxkLGcsaCxpLEk9ZSYmZS5zcGxpdCgiLyIpO249STt2YXIgbT1sLm1hcCxrPW0mJm1bIioiXTtpZihhJiYiLiI9PT1hLmNoYXJBdCgwKSlpZihlKXtuPQ0KSS5zbGljZSgwLEkubGVuZ3RoLTEpO2E9YS5zcGxpdCgiLyIpO2U9YS5sZW5ndGgtMTtsLm5vZGVJZENvbXBhdCYmUi50ZXN0KGFbZV0pJiYoYVtlXT1hW2VdLnJlcGxhY2UoUiwiIikpO249YT1uLmNvbmNhdChhKTtkPW4ubGVuZ3RoO2ZvcihlPTA7ZTxkO2UrKylpZihjPW5bZV0sIi4iPT09YyluLnNwbGljZShlLDEpLGUtPTE7ZWxzZSBpZigiLi4iPT09YylpZigxPT09ZSYmKCIuLiI9PT1uWzJdfHwiLi4iPT09blswXSkpYnJlYWs7ZWxzZSAwPGUmJihuLnNwbGljZShlLTEsMiksZS09Mik7YT1hLmpvaW4oIi8iKX1lbHNlIDA9PT1hLmluZGV4T2YoIi4vIikmJihhPWEuc3Vic3RyaW5nKDIpKTtpZihiJiZtJiYoSXx8aykpe249YS5zcGxpdCgiLyIpO2U9bi5sZW5ndGg7YTpmb3IoOzA8ZTtlLT0xKXtkPW4uc2xpY2UoMCxlKS5qb2luKCIvIik7aWYoSSlmb3IoYz1JLmxlbmd0aDswPGM7Yy09MSlpZihiPWoobSxJLnNsaWNlKDAsYykuam9pbigiLyIpKSlpZihiPWooYixkKSl7Zj1iOw0KZz1lO2JyZWFrIGF9IWgmJihrJiZqKGssZCkpJiYoaD1qKGssZCksaT1lKX0hZiYmaCYmKGY9aCxnPWkpO2YmJihuLnNwbGljZSgwLGcsZiksYT1uLmpvaW4oIi8iKSl9cmV0dXJuKGY9aihsLnBrZ3MsYSkpP2Y6YX1mdW5jdGlvbiBkKGEpe3omJnYoZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInNjcmlwdCIpLGZ1bmN0aW9uKGUpe2lmKGUuZ2V0QXR0cmlidXRlKCJkYXRhLXJlcXVpcmVtb2R1bGUiKT09PWEmJmUuZ2V0QXR0cmlidXRlKCJkYXRhLXJlcXVpcmVjb250ZXh0Iik9PT1pLmNvbnRleHROYW1lKXJldHVybiBlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZSksITB9KX1mdW5jdGlvbiBnKGEpe3ZhciBlPWoobC5wYXRocyxhKTtpZihlJiZIKGUpJiYxPGUubGVuZ3RoKXJldHVybiBlLnNoaWZ0KCksaS5yZXF1aXJlLnVuZGVmKGEpLGkucmVxdWlyZShbYV0pLCEwfWZ1bmN0aW9uIHUoYSl7dmFyIGUsYj1hP2EuaW5kZXhPZigiISIpOi0xOy0xPGImJihlPWEuc3Vic3RyaW5nKDAsDQpiKSxhPWEuc3Vic3RyaW5nKGIrMSxhLmxlbmd0aCkpO3JldHVybltlLGFdfWZ1bmN0aW9uIG0oYSxlLGIsZil7dmFyIG4sZCxnPW51bGwsaD1lP2UubmFtZTpudWxsLGw9YSxtPSEwLGs9IiI7YXx8KG09ITEsYT0iX0ByIisoTSs9MSkpO2E9dShhKTtnPWFbMF07YT1hWzFdO2cmJihnPWMoZyxoLGYpLGQ9aihwLGcpKTthJiYoZz9rPWQmJmQubm9ybWFsaXplP2Qubm9ybWFsaXplKGEsZnVuY3Rpb24oYSl7cmV0dXJuIGMoYSxoLGYpfSk6YyhhLGgsZik6KGs9YyhhLGgsZiksYT11KGspLGc9YVswXSxrPWFbMV0sYj0hMCxuPWkubmFtZVRvVXJsKGspKSk7Yj1nJiYhZCYmIWI/Il91bm5vcm1hbGl6ZWQiKyhRKz0xKToiIjtyZXR1cm57cHJlZml4OmcsbmFtZTprLHBhcmVudE1hcDplLHVubm9ybWFsaXplZDohIWIsdXJsOm4sb3JpZ2luYWxOYW1lOmwsaXNEZWZpbmU6bSxpZDooZz9nKyIhIitrOmspK2J9fWZ1bmN0aW9uIHEoYSl7dmFyIGU9YS5pZCxiPWooayxlKTtifHwoYj1rW2VdPW5ldyBpLk1vZHVsZShhKSk7DQpyZXR1cm4gYn1mdW5jdGlvbiByKGEsZSxiKXt2YXIgZj1hLmlkLG49aihrLGYpO2lmKHMocCxmKSYmKCFufHxuLmRlZmluZUVtaXRDb21wbGV0ZSkpImRlZmluZWQiPT09ZSYmYihwW2ZdKTtlbHNlIGlmKG49cShhKSxuLmVycm9yJiYiZXJyb3IiPT09ZSliKG4uZXJyb3IpO2Vsc2Ugbi5vbihlLGIpfWZ1bmN0aW9uIHcoYSxlKXt2YXIgYj1hLnJlcXVpcmVNb2R1bGVzLGY9ITE7aWYoZSllKGEpO2Vsc2UgaWYodihiLGZ1bmN0aW9uKGUpe2lmKGU9aihrLGUpKWUuZXJyb3I9YSxlLmV2ZW50cy5lcnJvciYmKGY9ITAsZS5lbWl0KCJlcnJvciIsYSkpfSksIWYpaC5vbkVycm9yKGEpfWZ1bmN0aW9uIHgoKXtTLmxlbmd0aCYmKGlhLmFwcGx5KEEsW0EubGVuZ3RoLDBdLmNvbmNhdChTKSksUz1bXSl9ZnVuY3Rpb24geShhKXtkZWxldGUga1thXTtkZWxldGUgV1thXX1mdW5jdGlvbiBGKGEsZSxiKXt2YXIgZj1hLm1hcC5pZDthLmVycm9yP2EuZW1pdCgiZXJyb3IiLGEuZXJyb3IpOihlW2ZdPQ0KITAsdihhLmRlcE1hcHMsZnVuY3Rpb24oZixjKXt2YXIgZD1mLmlkLGc9aihrLGQpO2cmJighYS5kZXBNYXRjaGVkW2NdJiYhYltkXSkmJihqKGUsZCk/KGEuZGVmaW5lRGVwKGMscFtkXSksYS5jaGVjaygpKTpGKGcsZSxiKSl9KSxiW2ZdPSEwKX1mdW5jdGlvbiBEKCl7dmFyIGEsZSxiPShhPTFFMypsLndhaXRTZWNvbmRzKSYmaS5zdGFydFRpbWUrYTwobmV3IERhdGUpLmdldFRpbWUoKSxmPVtdLGM9W10saD0hMSxrPSEwO2lmKCFYKXtYPSEwO0IoVyxmdW5jdGlvbihhKXt2YXIgaT1hLm1hcCxtPWkuaWQ7aWYoYS5lbmFibGVkJiYoaS5pc0RlZmluZXx8Yy5wdXNoKGEpLCFhLmVycm9yKSlpZighYS5pbml0ZWQmJmIpZyhtKT9oPWU9ITA6KGYucHVzaChtKSxkKG0pKTtlbHNlIGlmKCFhLmluaXRlZCYmKGEuZmV0Y2hlZCYmaS5pc0RlZmluZSkmJihoPSEwLCFpLnByZWZpeCkpcmV0dXJuIGs9ITF9KTtpZihiJiZmLmxlbmd0aClyZXR1cm4gYT1DKCJ0aW1lb3V0IiwiTG9hZCB0aW1lb3V0IGZvciBtb2R1bGVzOiAiKw0KZixudWxsLGYpLGEuY29udGV4dE5hbWU9aS5jb250ZXh0TmFtZSx3KGEpO2smJnYoYyxmdW5jdGlvbihhKXtGKGEse30se30pfSk7aWYoKCFifHxlKSYmaClpZigoenx8ZmEpJiYhWSlZPXNldFRpbWVvdXQoZnVuY3Rpb24oKXtZPTA7RCgpfSw1MCk7WD0hMX19ZnVuY3Rpb24gRShhKXtzKHAsYVswXSl8fHEobShhWzBdLG51bGwsITApKS5pbml0KGFbMV0sYVsyXSl9ZnVuY3Rpb24gSyhhKXt2YXIgYT1hLmN1cnJlbnRUYXJnZXR8fGEuc3JjRWxlbWVudCxlPWkub25TY3JpcHRMb2FkO2EuZGV0YWNoRXZlbnQmJiFaP2EuZGV0YWNoRXZlbnQoIm9ucmVhZHlzdGF0ZWNoYW5nZSIsZSk6YS5yZW1vdmVFdmVudExpc3RlbmVyKCJsb2FkIixlLCExKTtlPWkub25TY3JpcHRFcnJvcjsoIWEuZGV0YWNoRXZlbnR8fFopJiZhLnJlbW92ZUV2ZW50TGlzdGVuZXIoImVycm9yIixlLCExKTtyZXR1cm57bm9kZTphLGlkOmEmJmEuZ2V0QXR0cmlidXRlKCJkYXRhLXJlcXVpcmVtb2R1bGUiKX19ZnVuY3Rpb24gTCgpe3ZhciBhOw0KZm9yKHgoKTtBLmxlbmd0aDspe2E9QS5zaGlmdCgpO2lmKG51bGw9PT1hWzBdKXJldHVybiB3KEMoIm1pc21hdGNoIiwiTWlzbWF0Y2hlZCBhbm9ueW1vdXMgZGVmaW5lKCkgbW9kdWxlOiAiK2FbYS5sZW5ndGgtMV0pKTtFKGEpfX12YXIgWCwkLGksTixZLGw9e3dhaXRTZWNvbmRzOjcsYmFzZVVybDoiLi8iLHBhdGhzOnt9LGJ1bmRsZXM6e30scGtnczp7fSxzaGltOnt9LGNvbmZpZzp7fX0saz17fSxXPXt9LGFhPXt9LEE9W10scD17fSxUPXt9LGJhPXt9LE09MSxRPTE7Tj17cmVxdWlyZTpmdW5jdGlvbihhKXtyZXR1cm4gYS5yZXF1aXJlP2EucmVxdWlyZTphLnJlcXVpcmU9aS5tYWtlUmVxdWlyZShhLm1hcCl9LGV4cG9ydHM6ZnVuY3Rpb24oYSl7YS51c2luZ0V4cG9ydHM9ITA7aWYoYS5tYXAuaXNEZWZpbmUpcmV0dXJuIGEuZXhwb3J0cz9wW2EubWFwLmlkXT1hLmV4cG9ydHM6YS5leHBvcnRzPXBbYS5tYXAuaWRdPXt9fSxtb2R1bGU6ZnVuY3Rpb24oYSl7cmV0dXJuIGEubW9kdWxlPw0KYS5tb2R1bGU6YS5tb2R1bGU9e2lkOmEubWFwLmlkLHVyaTphLm1hcC51cmwsY29uZmlnOmZ1bmN0aW9uKCl7cmV0dXJuIGoobC5jb25maWcsYS5tYXAuaWQpfHx7fX0sZXhwb3J0czphLmV4cG9ydHN8fChhLmV4cG9ydHM9e30pfX19OyQ9ZnVuY3Rpb24oYSl7dGhpcy5ldmVudHM9aihhYSxhLmlkKXx8e307dGhpcy5tYXA9YTt0aGlzLnNoaW09aihsLnNoaW0sYS5pZCk7dGhpcy5kZXBFeHBvcnRzPVtdO3RoaXMuZGVwTWFwcz1bXTt0aGlzLmRlcE1hdGNoZWQ9W107dGhpcy5wbHVnaW5NYXBzPXt9O3RoaXMuZGVwQ291bnQ9MH07JC5wcm90b3R5cGU9e2luaXQ6ZnVuY3Rpb24oYSxlLGIsZil7Zj1mfHx7fTtpZighdGhpcy5pbml0ZWQpe3RoaXMuZmFjdG9yeT1lO2lmKGIpdGhpcy5vbigiZXJyb3IiLGIpO2Vsc2UgdGhpcy5ldmVudHMuZXJyb3ImJihiPXQodGhpcyxmdW5jdGlvbihhKXt0aGlzLmVtaXQoImVycm9yIixhKX0pKTt0aGlzLmRlcE1hcHM9YSYmYS5zbGljZSgwKTt0aGlzLmVycmJhY2s9DQpiO3RoaXMuaW5pdGVkPSEwO3RoaXMuaWdub3JlPWYuaWdub3JlO2YuZW5hYmxlZHx8dGhpcy5lbmFibGVkP3RoaXMuZW5hYmxlKCk6dGhpcy5jaGVjaygpfX0sZGVmaW5lRGVwOmZ1bmN0aW9uKGEsZSl7dGhpcy5kZXBNYXRjaGVkW2FdfHwodGhpcy5kZXBNYXRjaGVkW2FdPSEwLHRoaXMuZGVwQ291bnQtPTEsdGhpcy5kZXBFeHBvcnRzW2FdPWUpfSxmZXRjaDpmdW5jdGlvbigpe2lmKCF0aGlzLmZldGNoZWQpe3RoaXMuZmV0Y2hlZD0hMDtpLnN0YXJ0VGltZT0obmV3IERhdGUpLmdldFRpbWUoKTt2YXIgYT10aGlzLm1hcDtpZih0aGlzLnNoaW0paS5tYWtlUmVxdWlyZSh0aGlzLm1hcCx7ZW5hYmxlQnVpbGRDYWxsYmFjazohMH0pKHRoaXMuc2hpbS5kZXBzfHxbXSx0KHRoaXMsZnVuY3Rpb24oKXtyZXR1cm4gYS5wcmVmaXg/dGhpcy5jYWxsUGx1Z2luKCk6dGhpcy5sb2FkKCl9KSk7ZWxzZSByZXR1cm4gYS5wcmVmaXg/dGhpcy5jYWxsUGx1Z2luKCk6dGhpcy5sb2FkKCl9fSxsb2FkOmZ1bmN0aW9uKCl7dmFyIGE9DQp0aGlzLm1hcC51cmw7VFthXXx8KFRbYV09ITAsaS5sb2FkKHRoaXMubWFwLmlkLGEpKX0sY2hlY2s6ZnVuY3Rpb24oKXtpZih0aGlzLmVuYWJsZWQmJiF0aGlzLmVuYWJsaW5nKXt2YXIgYSxlLGI9dGhpcy5tYXAuaWQ7ZT10aGlzLmRlcEV4cG9ydHM7dmFyIGY9dGhpcy5leHBvcnRzLGM9dGhpcy5mYWN0b3J5O2lmKHRoaXMuaW5pdGVkKWlmKHRoaXMuZXJyb3IpdGhpcy5lbWl0KCJlcnJvciIsdGhpcy5lcnJvcik7ZWxzZXtpZighdGhpcy5kZWZpbmluZyl7dGhpcy5kZWZpbmluZz0hMDtpZigxPnRoaXMuZGVwQ291bnQmJiF0aGlzLmRlZmluZWQpe2lmKEcoYykpe2lmKHRoaXMuZXZlbnRzLmVycm9yJiZ0aGlzLm1hcC5pc0RlZmluZXx8aC5vbkVycm9yIT09ZGEpdHJ5e2Y9aS5leGVjQ2IoYixjLGUsZil9Y2F0Y2goZCl7YT1kfWVsc2UgZj1pLmV4ZWNDYihiLGMsZSxmKTt0aGlzLm1hcC5pc0RlZmluZSYmdm9pZCAwPT09ZiYmKChlPXRoaXMubW9kdWxlKT9mPWUuZXhwb3J0czp0aGlzLnVzaW5nRXhwb3J0cyYmDQooZj10aGlzLmV4cG9ydHMpKTtpZihhKXJldHVybiBhLnJlcXVpcmVNYXA9dGhpcy5tYXAsYS5yZXF1aXJlTW9kdWxlcz10aGlzLm1hcC5pc0RlZmluZT9bdGhpcy5tYXAuaWRdOm51bGwsYS5yZXF1aXJlVHlwZT10aGlzLm1hcC5pc0RlZmluZT8iZGVmaW5lIjoicmVxdWlyZSIsdyh0aGlzLmVycm9yPWEpfWVsc2UgZj1jO3RoaXMuZXhwb3J0cz1mO2lmKHRoaXMubWFwLmlzRGVmaW5lJiYhdGhpcy5pZ25vcmUmJihwW2JdPWYsaC5vblJlc291cmNlTG9hZCkpaC5vblJlc291cmNlTG9hZChpLHRoaXMubWFwLHRoaXMuZGVwTWFwcyk7eShiKTt0aGlzLmRlZmluZWQ9ITB9dGhpcy5kZWZpbmluZz0hMTt0aGlzLmRlZmluZWQmJiF0aGlzLmRlZmluZUVtaXR0ZWQmJih0aGlzLmRlZmluZUVtaXR0ZWQ9ITAsdGhpcy5lbWl0KCJkZWZpbmVkIix0aGlzLmV4cG9ydHMpLHRoaXMuZGVmaW5lRW1pdENvbXBsZXRlPSEwKX19ZWxzZSB0aGlzLmZldGNoKCl9fSxjYWxsUGx1Z2luOmZ1bmN0aW9uKCl7dmFyIGE9DQp0aGlzLm1hcCxiPWEuaWQsZD1tKGEucHJlZml4KTt0aGlzLmRlcE1hcHMucHVzaChkKTtyKGQsImRlZmluZWQiLHQodGhpcyxmdW5jdGlvbihmKXt2YXIgZCxnO2c9aihiYSx0aGlzLm1hcC5pZCk7dmFyIEo9dGhpcy5tYXAubmFtZSx1PXRoaXMubWFwLnBhcmVudE1hcD90aGlzLm1hcC5wYXJlbnRNYXAubmFtZTpudWxsLHA9aS5tYWtlUmVxdWlyZShhLnBhcmVudE1hcCx7ZW5hYmxlQnVpbGRDYWxsYmFjazohMH0pO2lmKHRoaXMubWFwLnVubm9ybWFsaXplZCl7aWYoZi5ub3JtYWxpemUmJihKPWYubm9ybWFsaXplKEosZnVuY3Rpb24oYSl7cmV0dXJuIGMoYSx1LCEwKX0pfHwiIiksZj1tKGEucHJlZml4KyIhIitKLHRoaXMubWFwLnBhcmVudE1hcCkscihmLCJkZWZpbmVkIix0KHRoaXMsZnVuY3Rpb24oYSl7dGhpcy5pbml0KFtdLGZ1bmN0aW9uKCl7cmV0dXJuIGF9LG51bGwse2VuYWJsZWQ6ITAsaWdub3JlOiEwfSl9KSksZz1qKGssZi5pZCkpe3RoaXMuZGVwTWFwcy5wdXNoKGYpOw0KaWYodGhpcy5ldmVudHMuZXJyb3IpZy5vbigiZXJyb3IiLHQodGhpcyxmdW5jdGlvbihhKXt0aGlzLmVtaXQoImVycm9yIixhKX0pKTtnLmVuYWJsZSgpfX1lbHNlIGc/KHRoaXMubWFwLnVybD1pLm5hbWVUb1VybChnKSx0aGlzLmxvYWQoKSk6KGQ9dCh0aGlzLGZ1bmN0aW9uKGEpe3RoaXMuaW5pdChbXSxmdW5jdGlvbigpe3JldHVybiBhfSxudWxsLHtlbmFibGVkOiEwfSl9KSxkLmVycm9yPXQodGhpcyxmdW5jdGlvbihhKXt0aGlzLmluaXRlZD0hMDt0aGlzLmVycm9yPWE7YS5yZXF1aXJlTW9kdWxlcz1bYl07QihrLGZ1bmN0aW9uKGEpezA9PT1hLm1hcC5pZC5pbmRleE9mKGIrIl91bm5vcm1hbGl6ZWQiKSYmeShhLm1hcC5pZCl9KTt3KGEpfSksZC5mcm9tVGV4dD10KHRoaXMsZnVuY3Rpb24oZixjKXt2YXIgZz1hLm5hbWUsSj1tKGcpLGs9TztjJiYoZj1jKTtrJiYoTz0hMSk7cShKKTtzKGwuY29uZmlnLGIpJiYobC5jb25maWdbZ109bC5jb25maWdbYl0pO3RyeXtoLmV4ZWMoZil9Y2F0Y2goail7cmV0dXJuIHcoQygiZnJvbXRleHRldmFsIiwNCiJmcm9tVGV4dCBldmFsIGZvciAiK2IrIiBmYWlsZWQ6ICIraixqLFtiXSkpfWsmJihPPSEwKTt0aGlzLmRlcE1hcHMucHVzaChKKTtpLmNvbXBsZXRlTG9hZChnKTtwKFtnXSxkKX0pLGYubG9hZChhLm5hbWUscCxkLGwpKX0pKTtpLmVuYWJsZShkLHRoaXMpO3RoaXMucGx1Z2luTWFwc1tkLmlkXT1kfSxlbmFibGU6ZnVuY3Rpb24oKXtXW3RoaXMubWFwLmlkXT10aGlzO3RoaXMuZW5hYmxpbmc9dGhpcy5lbmFibGVkPSEwO3YodGhpcy5kZXBNYXBzLHQodGhpcyxmdW5jdGlvbihhLGIpe3ZhciBjLGY7aWYoInN0cmluZyI9PT10eXBlb2YgYSl7YT1tKGEsdGhpcy5tYXAuaXNEZWZpbmU/dGhpcy5tYXA6dGhpcy5tYXAucGFyZW50TWFwLCExLCF0aGlzLnNraXBNYXApO3RoaXMuZGVwTWFwc1tiXT1hO2lmKGM9aihOLGEuaWQpKXt0aGlzLmRlcEV4cG9ydHNbYl09Yyh0aGlzKTtyZXR1cm59dGhpcy5kZXBDb3VudCs9MTtyKGEsImRlZmluZWQiLHQodGhpcyxmdW5jdGlvbihhKXt0aGlzLmRlZmluZURlcChiLA0KYSk7dGhpcy5jaGVjaygpfSkpO3RoaXMuZXJyYmFjayYmcihhLCJlcnJvciIsdCh0aGlzLHRoaXMuZXJyYmFjaykpfWM9YS5pZDtmPWtbY107IXMoTixjKSYmKGYmJiFmLmVuYWJsZWQpJiZpLmVuYWJsZShhLHRoaXMpfSkpO0IodGhpcy5wbHVnaW5NYXBzLHQodGhpcyxmdW5jdGlvbihhKXt2YXIgYj1qKGssYS5pZCk7YiYmIWIuZW5hYmxlZCYmaS5lbmFibGUoYSx0aGlzKX0pKTt0aGlzLmVuYWJsaW5nPSExO3RoaXMuY2hlY2soKX0sb246ZnVuY3Rpb24oYSxiKXt2YXIgYz10aGlzLmV2ZW50c1thXTtjfHwoYz10aGlzLmV2ZW50c1thXT1bXSk7Yy5wdXNoKGIpfSxlbWl0OmZ1bmN0aW9uKGEsYil7dih0aGlzLmV2ZW50c1thXSxmdW5jdGlvbihhKXthKGIpfSk7ImVycm9yIj09PWEmJmRlbGV0ZSB0aGlzLmV2ZW50c1thXX19O2k9e2NvbmZpZzpsLGNvbnRleHROYW1lOmIscmVnaXN0cnk6ayxkZWZpbmVkOnAsdXJsRmV0Y2hlZDpULGRlZlF1ZXVlOkEsTW9kdWxlOiQsbWFrZU1vZHVsZU1hcDptLA0KbmV4dFRpY2s6aC5uZXh0VGljayxvbkVycm9yOncsY29uZmlndXJlOmZ1bmN0aW9uKGEpe2EuYmFzZVVybCYmIi8iIT09YS5iYXNlVXJsLmNoYXJBdChhLmJhc2VVcmwubGVuZ3RoLTEpJiYoYS5iYXNlVXJsKz0iLyIpO3ZhciBiPWwuc2hpbSxjPXtwYXRoczohMCxidW5kbGVzOiEwLGNvbmZpZzohMCxtYXA6ITB9O0IoYSxmdW5jdGlvbihhLGIpe2NbYl0/KGxbYl18fChsW2JdPXt9KSxWKGxbYl0sYSwhMCwhMCkpOmxbYl09YX0pO2EuYnVuZGxlcyYmQihhLmJ1bmRsZXMsZnVuY3Rpb24oYSxiKXt2KGEsZnVuY3Rpb24oYSl7YSE9PWImJihiYVthXT1iKX0pfSk7YS5zaGltJiYoQihhLnNoaW0sZnVuY3Rpb24oYSxjKXtIKGEpJiYoYT17ZGVwczphfSk7aWYoKGEuZXhwb3J0c3x8YS5pbml0KSYmIWEuZXhwb3J0c0ZuKWEuZXhwb3J0c0ZuPWkubWFrZVNoaW1FeHBvcnRzKGEpO2JbY109YX0pLGwuc2hpbT1iKTthLnBhY2thZ2VzJiZ2KGEucGFja2FnZXMsZnVuY3Rpb24oYSl7dmFyIGIsDQphPSJzdHJpbmciPT09dHlwZW9mIGE/e25hbWU6YX06YTtiPWEubmFtZTthLmxvY2F0aW9uJiYobC5wYXRoc1tiXT1hLmxvY2F0aW9uKTtsLnBrZ3NbYl09YS5uYW1lKyIvIisoYS5tYWlufHwibWFpbiIpLnJlcGxhY2UoamEsIiIpLnJlcGxhY2UoUiwiIil9KTtCKGssZnVuY3Rpb24oYSxiKXshYS5pbml0ZWQmJiFhLm1hcC51bm5vcm1hbGl6ZWQmJihhLm1hcD1tKGIpKX0pO2lmKGEuZGVwc3x8YS5jYWxsYmFjaylpLnJlcXVpcmUoYS5kZXBzfHxbXSxhLmNhbGxiYWNrKX0sbWFrZVNoaW1FeHBvcnRzOmZ1bmN0aW9uKGEpe3JldHVybiBmdW5jdGlvbigpe3ZhciBiO2EuaW5pdCYmKGI9YS5pbml0LmFwcGx5KGNhLGFyZ3VtZW50cykpO3JldHVybiBifHxhLmV4cG9ydHMmJmVhKGEuZXhwb3J0cyl9fSxtYWtlUmVxdWlyZTpmdW5jdGlvbihhLGUpe2Z1bmN0aW9uIGcoZixjLGQpe3ZhciBqLGw7ZS5lbmFibGVCdWlsZENhbGxiYWNrJiYoYyYmRyhjKSkmJihjLl9fcmVxdWlyZUpzQnVpbGQ9DQohMCk7aWYoInN0cmluZyI9PT10eXBlb2YgZil7aWYoRyhjKSlyZXR1cm4gdyhDKCJyZXF1aXJlYXJncyIsIkludmFsaWQgcmVxdWlyZSBjYWxsIiksZCk7aWYoYSYmcyhOLGYpKXJldHVybiBOW2ZdKGtbYS5pZF0pO2lmKGguZ2V0KXJldHVybiBoLmdldChpLGYsYSxnKTtqPW0oZixhLCExLCEwKTtqPWouaWQ7cmV0dXJuIXMocCxqKT93KEMoIm5vdGxvYWRlZCIsJ01vZHVsZSBuYW1lICInK2orJyIgaGFzIG5vdCBiZWVuIGxvYWRlZCB5ZXQgZm9yIGNvbnRleHQ6ICcrYisoYT8iIjoiLiBVc2UgcmVxdWlyZShbXSkiKSkpOnBbal19TCgpO2kubmV4dFRpY2soZnVuY3Rpb24oKXtMKCk7bD1xKG0obnVsbCxhKSk7bC5za2lwTWFwPWUuc2tpcE1hcDtsLmluaXQoZixjLGQse2VuYWJsZWQ6ITB9KTtEKCl9KTtyZXR1cm4gZ31lPWV8fHt9O1YoZyx7aXNCcm93c2VyOnosdG9Vcmw6ZnVuY3Rpb24oYil7dmFyIGUsZD1iLmxhc3RJbmRleE9mKCIuIiksZz1iLnNwbGl0KCIvIilbMF07aWYoLTEhPT0NCmQmJighKCIuIj09PWd8fCIuLiI9PT1nKXx8MTxkKSllPWIuc3Vic3RyaW5nKGQsYi5sZW5ndGgpLGI9Yi5zdWJzdHJpbmcoMCxkKTtyZXR1cm4gaS5uYW1lVG9VcmwoYyhiLGEmJmEuaWQsITApLGUsITApfSxkZWZpbmVkOmZ1bmN0aW9uKGIpe3JldHVybiBzKHAsbShiLGEsITEsITApLmlkKX0sc3BlY2lmaWVkOmZ1bmN0aW9uKGIpe2I9bShiLGEsITEsITApLmlkO3JldHVybiBzKHAsYil8fHMoayxiKX19KTthfHwoZy51bmRlZj1mdW5jdGlvbihiKXt4KCk7dmFyIGM9bShiLGEsITApLGU9aihrLGIpO2QoYik7ZGVsZXRlIHBbYl07ZGVsZXRlIFRbYy51cmxdO2RlbGV0ZSBhYVtiXTtVKEEsZnVuY3Rpb24oYSxjKXthWzBdPT09YiYmQS5zcGxpY2UoYywxKX0pO2UmJihlLmV2ZW50cy5kZWZpbmVkJiYoYWFbYl09ZS5ldmVudHMpLHkoYikpfSk7cmV0dXJuIGd9LGVuYWJsZTpmdW5jdGlvbihhKXtqKGssYS5pZCkmJnEoYSkuZW5hYmxlKCl9LGNvbXBsZXRlTG9hZDpmdW5jdGlvbihhKXt2YXIgYiwNCmMsZj1qKGwuc2hpbSxhKXx8e30sZD1mLmV4cG9ydHM7Zm9yKHgoKTtBLmxlbmd0aDspe2M9QS5zaGlmdCgpO2lmKG51bGw9PT1jWzBdKXtjWzBdPWE7aWYoYilicmVhaztiPSEwfWVsc2UgY1swXT09PWEmJihiPSEwKTtFKGMpfWM9aihrLGEpO2lmKCFiJiYhcyhwLGEpJiZjJiYhYy5pbml0ZWQpe2lmKGwuZW5mb3JjZURlZmluZSYmKCFkfHwhZWEoZCkpKXJldHVybiBnKGEpP3ZvaWQgMDp3KEMoIm5vZGVmaW5lIiwiTm8gZGVmaW5lIGNhbGwgZm9yICIrYSxudWxsLFthXSkpO0UoW2EsZi5kZXBzfHxbXSxmLmV4cG9ydHNGbl0pfUQoKX0sbmFtZVRvVXJsOmZ1bmN0aW9uKGEsYixjKXt2YXIgZixkLGc7KGY9aihsLnBrZ3MsYSkpJiYoYT1mKTtpZihmPWooYmEsYSkpcmV0dXJuIGkubmFtZVRvVXJsKGYsYixjKTtpZihoLmpzRXh0UmVnRXhwLnRlc3QoYSkpZj1hKyhifHwiIik7ZWxzZXtmPWwucGF0aHM7YT1hLnNwbGl0KCIvIik7Zm9yKGQ9YS5sZW5ndGg7MDxkO2QtPTEpaWYoZz1hLnNsaWNlKDAsDQpkKS5qb2luKCIvIiksZz1qKGYsZykpe0goZykmJihnPWdbMF0pO2Euc3BsaWNlKDAsZCxnKTticmVha31mPWEuam9pbigiLyIpO2YrPWJ8fCgvXmRhdGFcOnxcPy8udGVzdChmKXx8Yz8iIjoiLmpzIik7Zj0oIi8iPT09Zi5jaGFyQXQoMCl8fGYubWF0Y2goL15bXHdcK1wuXC1dKzovKT8iIjpsLmJhc2VVcmwpK2Z9cmV0dXJuIGwudXJsQXJncz9mKygoLTE9PT1mLmluZGV4T2YoIj8iKT8iPyI6IiYiKStsLnVybEFyZ3MpOmZ9LGxvYWQ6ZnVuY3Rpb24oYSxiKXtoLmxvYWQoaSxhLGIpfSxleGVjQ2I6ZnVuY3Rpb24oYSxiLGMsZCl7cmV0dXJuIGIuYXBwbHkoZCxjKX0sb25TY3JpcHRMb2FkOmZ1bmN0aW9uKGEpe2lmKCJsb2FkIj09PWEudHlwZXx8a2EudGVzdCgoYS5jdXJyZW50VGFyZ2V0fHxhLnNyY0VsZW1lbnQpLnJlYWR5U3RhdGUpKVA9bnVsbCxhPUsoYSksaS5jb21wbGV0ZUxvYWQoYS5pZCl9LG9uU2NyaXB0RXJyb3I6ZnVuY3Rpb24oYSl7dmFyIGI9SyhhKTtpZighZyhiLmlkKSlyZXR1cm4gdyhDKCJzY3JpcHRlcnJvciIsDQoiU2NyaXB0IGVycm9yIGZvcjogIitiLmlkLGEsW2IuaWRdKSl9fTtpLnJlcXVpcmU9aS5tYWtlUmVxdWlyZSgpO3JldHVybiBpfXZhciBoLHgseSxELEssRSxQLEwscSxRLGxhPS8oXC9cKihbXHNcU10qPylcKlwvfChbXjpdfF4pXC9cLyguKikkKS9tZyxtYT0vW14uXVxzKnJlcXVpcmVccypcKFxzKlsiJ10oW14nIlxzXSspWyInXVxzKlwpL2csUj0vXC5qcyQvLGphPS9eXC5cLy87eD1PYmplY3QucHJvdG90eXBlO3ZhciBNPXgudG9TdHJpbmcsZ2E9eC5oYXNPd25Qcm9wZXJ0eSxpYT1BcnJheS5wcm90b3R5cGUuc3BsaWNlLHo9ISEoInVuZGVmaW5lZCIhPT10eXBlb2Ygd2luZG93JiYidW5kZWZpbmVkIiE9PXR5cGVvZiBuYXZpZ2F0b3ImJndpbmRvdy5kb2N1bWVudCksZmE9IXomJiJ1bmRlZmluZWQiIT09dHlwZW9mIGltcG9ydFNjcmlwdHMsa2E9eiYmIlBMQVlTVEFUSU9OIDMiPT09bmF2aWdhdG9yLnBsYXRmb3JtPy9eY29tcGxldGUkLzovXihjb21wbGV0ZXxsb2FkZWQpJC8sDQpaPSJ1bmRlZmluZWQiIT09dHlwZW9mIG9wZXJhJiYiW29iamVjdCBPcGVyYV0iPT09b3BlcmEudG9TdHJpbmcoKSxGPXt9LHI9e30sUz1bXSxPPSExO2lmKCJ1bmRlZmluZWQiPT09dHlwZW9mIGRlZmluZSl7aWYoInVuZGVmaW5lZCIhPT10eXBlb2YgcmVxdWlyZWpzKXtpZihHKHJlcXVpcmVqcykpcmV0dXJuO3I9cmVxdWlyZWpzO3JlcXVpcmVqcz12b2lkIDB9InVuZGVmaW5lZCIhPT10eXBlb2YgcmVxdWlyZSYmIUcocmVxdWlyZSkmJihyPXJlcXVpcmUscmVxdWlyZT12b2lkIDApO2g9cmVxdWlyZWpzPWZ1bmN0aW9uKGIsYyxkLGcpe3ZhciB1LG09Il8iOyFIKGIpJiYic3RyaW5nIiE9PXR5cGVvZiBiJiYodT1iLEgoYyk/KGI9YyxjPWQsZD1nKTpiPVtdKTt1JiZ1LmNvbnRleHQmJihtPXUuY29udGV4dCk7KGc9aihGLG0pKXx8KGc9RlttXT1oLnMubmV3Q29udGV4dChtKSk7dSYmZy5jb25maWd1cmUodSk7cmV0dXJuIGcucmVxdWlyZShiLGMsZCl9O2guY29uZmlnPWZ1bmN0aW9uKGIpe3JldHVybiBoKGIpfTsNCmgubmV4dFRpY2s9InVuZGVmaW5lZCIhPT10eXBlb2Ygc2V0VGltZW91dD9mdW5jdGlvbihiKXtzZXRUaW1lb3V0KGIsNCl9OmZ1bmN0aW9uKGIpe2IoKX07cmVxdWlyZXx8KHJlcXVpcmU9aCk7aC52ZXJzaW9uPSIyLjEuMTEiO2guanNFeHRSZWdFeHA9L15cL3w6fFw/fFwuanMkLztoLmlzQnJvd3Nlcj16O3g9aC5zPXtjb250ZXh0czpGLG5ld0NvbnRleHQ6aGF9O2goe30pO3YoWyJ0b1VybCIsInVuZGVmIiwiZGVmaW5lZCIsInNwZWNpZmllZCJdLGZ1bmN0aW9uKGIpe2hbYl09ZnVuY3Rpb24oKXt2YXIgYz1GLl87cmV0dXJuIGMucmVxdWlyZVtiXS5hcHBseShjLGFyZ3VtZW50cyl9fSk7aWYoeiYmKHk9eC5oZWFkPWRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJoZWFkIilbMF0sRD1kb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYmFzZSIpWzBdKSl5PXguaGVhZD1ELnBhcmVudE5vZGU7aC5vbkVycm9yPWRhO2guY3JlYXRlTm9kZT1mdW5jdGlvbihiKXt2YXIgYz0NCmIueGh0bWw/ZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKCJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiwiaHRtbDpzY3JpcHQiKTpkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTtjLnR5cGU9Yi5zY3JpcHRUeXBlfHwidGV4dC9qYXZhc2NyaXB0IjtjLmNoYXJzZXQ9InV0Zi04IjtjLmFzeW5jPSEwO3JldHVybiBjfTtoLmxvYWQ9ZnVuY3Rpb24oYixjLGQpe3ZhciBnPWImJmIuY29uZmlnfHx7fTtpZih6KXJldHVybiBnPWguY3JlYXRlTm9kZShnLGMsZCksZy5zZXRBdHRyaWJ1dGUoImRhdGEtcmVxdWlyZWNvbnRleHQiLGIuY29udGV4dE5hbWUpLGcuc2V0QXR0cmlidXRlKCJkYXRhLXJlcXVpcmVtb2R1bGUiLGMpLGcuYXR0YWNoRXZlbnQmJiEoZy5hdHRhY2hFdmVudC50b1N0cmluZyYmMD5nLmF0dGFjaEV2ZW50LnRvU3RyaW5nKCkuaW5kZXhPZigiW25hdGl2ZSBjb2RlIikpJiYhWj8oTz0hMCxnLmF0dGFjaEV2ZW50KCJvbnJlYWR5c3RhdGVjaGFuZ2UiLGIub25TY3JpcHRMb2FkKSk6DQooZy5hZGRFdmVudExpc3RlbmVyKCJsb2FkIixiLm9uU2NyaXB0TG9hZCwhMSksZy5hZGRFdmVudExpc3RlbmVyKCJlcnJvciIsYi5vblNjcmlwdEVycm9yLCExKSksZy5zcmM9ZCxMPWcsRD95Lmluc2VydEJlZm9yZShnLEQpOnkuYXBwZW5kQ2hpbGQoZyksTD1udWxsLGc7aWYoZmEpdHJ5e2ltcG9ydFNjcmlwdHMoZCksYi5jb21wbGV0ZUxvYWQoYyl9Y2F0Y2goail7Yi5vbkVycm9yKEMoImltcG9ydHNjcmlwdHMiLCJpbXBvcnRTY3JpcHRzIGZhaWxlZCBmb3IgIitjKyIgYXQgIitkLGosW2NdKSl9fTt6JiYhci5za2lwRGF0YU1haW4mJlUoZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInNjcmlwdCIpLGZ1bmN0aW9uKGIpe3l8fCh5PWIucGFyZW50Tm9kZSk7aWYoSz1iLmdldEF0dHJpYnV0ZSgiZGF0YS1tYWluIikpcmV0dXJuIHE9SyxyLmJhc2VVcmx8fChFPXEuc3BsaXQoIi8iKSxxPUUucG9wKCksUT1FLmxlbmd0aD9FLmpvaW4oIi8iKSsiLyI6Ii4vIixyLmJhc2VVcmw9DQpRKSxxPXEucmVwbGFjZShSLCIiKSxoLmpzRXh0UmVnRXhwLnRlc3QocSkmJihxPUspLHIuZGVwcz1yLmRlcHM/ci5kZXBzLmNvbmNhdChxKTpbcV0sITB9KTtkZWZpbmU9ZnVuY3Rpb24oYixjLGQpe3ZhciBnLGg7InN0cmluZyIhPT10eXBlb2YgYiYmKGQ9YyxjPWIsYj1udWxsKTtIKGMpfHwoZD1jLGM9bnVsbCk7IWMmJkcoZCkmJihjPVtdLGQubGVuZ3RoJiYoZC50b1N0cmluZygpLnJlcGxhY2UobGEsIiIpLnJlcGxhY2UobWEsZnVuY3Rpb24oYixkKXtjLnB1c2goZCl9KSxjPSgxPT09ZC5sZW5ndGg/WyJyZXF1aXJlIl06WyJyZXF1aXJlIiwiZXhwb3J0cyIsIm1vZHVsZSJdKS5jb25jYXQoYykpKTtpZihPKXtpZighKGc9TCkpUCYmImludGVyYWN0aXZlIj09PVAucmVhZHlTdGF0ZXx8VShkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgic2NyaXB0IiksZnVuY3Rpb24oYil7aWYoImludGVyYWN0aXZlIj09PWIucmVhZHlTdGF0ZSlyZXR1cm4gUD1ifSksZz1QO2cmJihifHwNCihiPWcuZ2V0QXR0cmlidXRlKCJkYXRhLXJlcXVpcmVtb2R1bGUiKSksaD1GW2cuZ2V0QXR0cmlidXRlKCJkYXRhLXJlcXVpcmVjb250ZXh0IildKX0oaD9oLmRlZlF1ZXVlOlMpLnB1c2goW2IsYyxkXSl9O2RlZmluZS5hbWQ9e2pRdWVyeTohMH07aC5leGVjPWZ1bmN0aW9uKGIpe3JldHVybiBldmFsKGIpfTtoKHIpfX0pKHRoaXMpOw0K"></script>
        <script>
        requirejs.config({
            baseUrl: '../js',
            "shim": {
                "underscore": { exports: "_" },
                "dat.gui": { exports: "dat.gui" },
                "smoothie": { exports: "SmoothieChart" },
                "stats.min": { exports: "Stats" },
                "jstat.min": { exports: "jStat" },
                "three": { exports: "THREE" },
                "Mirror": ["three"],
                "WaterShader": ["three"],
                "TerrainLoader": { deps: ["three"], exports: "TerrainLoader" },
                "TrackballControls": {  deps: ["three"], exports: "TrackballControls" },
                "OrbitControls": {  deps: ["three"], exports: "OrbitControls" },
                "PointerLockControls": {  deps: ["three"], exports: "PointerLockControls" },
            }
        })
        requirejs([
                "fp",
                "dat.gui",
                "smoothie",
                "csscolorparser",
                "stats.min",
                "jstat.min",
                "javascript.util",
                "jsts",
                "Mirror",
                "TerrainLoader",
                "THREEx.KeyboardState",
                "TrackballControls",
                "PointerLockControls",
            ],
            function( fp ) {
                var config = { = {
                  "preset": "Default",
                  "remembered": {
                    "Default": {
                        "1": {
                            "size": 1,
                            "initialPopulation": 50,
                            "establishLinks": false,
                            // "useTexture": true
                        },
                        "2": {
                            "create": false,
                            "maxNumber": 10000,
                            "rotateRandomly": false,
                            "rotateRandomly": false,
                            "showLines": false
                        },
                        "3": {
                            "create": false
                        },
                      "4": {
                            "buildingsShow": false,
                            "networkShow": false,
                            "networkCurve": false,
                            "terrainShow": true,
                            "dayShow": false,
                            "waterShow": false,
                            "skyboxShow": false,
                            "trailsShow": true,
                            "trailsShowAsLines": true,
                            "trailLength": 10000,
                            "patchesUpdate": false,
                            // "trailUpdateInterval": 1,
                            "cameraOverride": true,
                            "cameraX": 0,
                            "cameraY": 5000,
                            "cameraZ": 1000
                        },
                      "5": {
                            "colorNightTerrainLowland1": 0 * 256 * 256 + 0 * 256 + 0,
                            "colorNightBackground": 10 * 256 * 256 + 10 * 256 + 10,
                            "coloriseAgentsByHealth": false,
                        },
                      "6": {
                        "loadHeights": false,
                        "shaderUse": false,
                        "multiplier": 1
                    },
                    }
                  }
                }

                var disturbX = 0, disturbZ = 0;
                var stretch = 200;
                var turnBack = 200000;
                var leader;
                var nextWave = true;

                var getAngle = function( angle ) {

                    return angle;
                };

                var CustomAgent = function() {
                    var id = 0;
                    var localDisturbAngle = 0;
                    var localDisturbFactor = 0.1;
                    var next = null, current = null;
                    var nextAngle = 0, previousAngle = 0;
                    var sangle = 0;
                    var limit = 100;
                    var rad = 20;
                    var shift = 100;

                    fp.Agent.call( this );
                    this.move = function() {
                        this.lastPosition = this.position;
                        this.shiftPosition();
                    };
                    this.perturbDirection = function() {
                        var x = this.direction.x, z = this.direction.z, y = this.direction.y;
                        var px = this.position.x, pz = this.position.z, py = this.position.y;

                        // Halting condition
                        if ( px > fp.terrain.gridExtent / 2) {
                            this.direction.x = 0;
                            this.direction.z = 0;
                            nextWave = true;
                            fp.agentNetwork.agents = [];
                            return;
                        }

                        var cycle = ( ( fp.timescale.frameCounter % limit ) / limit );

                        // Reset target
                        if ( cycle == 0 || next == null ) {
                            // Pick a point 200 from current x
                            next = this.position.clone();
                            current = this.position.clone();

                            next.x += shift;

                            // Calculate a random position around radius of the next direction
                            previousAngle = nextAngle;
                            var rdmAngle = ( Math.PI * 2 ) * Math.random() - Math.PI ;
                            // Bias towards the x shift direction
                            // rdmAngle *= Math.sign( shift );
                            var nx = Math.cos( rdmAngle ) * rad;
                            var nz = Math.sin( rdmAngle ) * rad;
                            next.x += nx;
                            next.z += nz;
                            nextAngle = Math.atan2(next.z - current.z, next.x - current.x);
                            sangle = ( previousAngle == 0 ? 0 : previousAngle );
                            if ( this.id == 1 )
                                console.log(next.x, current.x, nx, nextAngle, shift)
                        }
                        var tmpX = ( next.x - current.x ) * ( 1 / limit );
                        var tmpZ = ( next.z - current.z ) * ( 1 / limit );
                        var hyp = Math.sqrt( tmpX * tmpX + tmpZ * tmpZ );
                        // Calculate a point on an inner circle to create a curve
                        sangle += ( nextAngle - previousAngle ) * ( 1 / limit );
                        xd = Math.cos( sangle ) * hyp;
                        zd = Math.sin( sangle ) * hyp;

                        var nix = 0, niz = 0;
                        var lix = 0, liz = 0;
                        if ( leader != null ) {
                            lix = leader.direction.x;
                            liz = leader.direction.z;
                        }
                        var ownWeight = 0.1;
                        var neighbourWeight = 0.0;
                        var leaderWeight = 0.9;
                        if ( this.id == 1 ) {
                            ownWeight = 1.0;
                            neighbourWeight = 0.0;
                            leaderWeight = 0.0;
                        }
                        var wxd = xd * ownWeight + nix * neighbourWeight + lix * leaderWeight;
                        var wzd = zd * ownWeight + niz * neighbourWeight + liz * leaderWeight;


                        this.direction.x = wxd;
                        this.direction.z = wzd;
                    };
                };
                CustomAgent.prototype = Object.create( fp.Agent.prototype );

                var waveCounter = 0, maxWaves = 1000;
                var createPop = function() {
                    waveCounter++;
                    if ( waveCounter < maxWaves )
                        setTimeout( createPop, 1000 );
                    if ( ! nextWave )
                        return;
                    nextWave = false;

                    var pop = fp.appConfig.agentOptions.initialPopulation;
                    for (var i = 0; i < pop; i++) {
                        fp.scene.remove( fp.agentNetwork.particles );
                        var agent = new CustomAgent();
                        agent.id = ( i + 1 );
                        if ( i == 0 )
                            leader = agent;
                        // var zCoord = i * ( stretch / pop ) - ( stretch / 2 ) + ( i * 2 );
                        var zRange = 2000;
                        var zCoord = Math.floor( Math.random() * zRange ) - ( zRange / 2 );
                        agent.lastPosition = agent.position = new THREE.Vector3( -fp.terrain.gridExtent / 2, 10 + waveCounter, zCoord );
                        // agent.lastPosition = agent.position = new THREE.Vector3( 0, 20, 0 );
                        agent.setDirection( new THREE.Vector3( 0, 0, 0 ) );
                        agent.color = "#" + ( fp.appConfig.colorOptions.colorNightAgent.toString(16) );
                        fp.agentNetwork.agents.push( agent );
                        fp.agentNetwork.updateAgentParticleSystem();
                    }
                    fp.trailNetwork.buildTrailNetwork( true );
                };

                var sim =  {
                    setup: function() {
                        disturbX = 0;
                        disturbZ = 0;
                        fp.timescale.framesToYear = 1; // VERY IMPORTANT! FORCE FULL EVALUATION EACH MOVEMENT
                        fp.timescale.endYear = 100000000;
                        fp.scene.remove( fp.agentNetwork.particles );
                        fp.agentNetwork.agents = [];
                        createPop();
                        fp.agentNetwork.buildAgentParticleSystem();

                        console.log("Custom set up")
                    },
                    tick: function() {
                        disturbFactor = 0.0001;
                        var nx = ( Math.random() - 0.5 ) * disturbFactor;
                        var nz = ( Math.random() - 0.5 ) * disturbFactor;
                        disturbX += nx;
                        if ( Math.abs( disturbZ + nz ) < 0.5 )
                            disturbZ += nz;
                        if ( fp.timescale.frameCounter % 20 == 0 ) {
                            //fp.trailNetwork.globalTrailLine.geometry.verticesNeedUpdate = true;
                        }
                    }
                }

                fp.init( config, sim, function() {
                    fp.appConfig.Setup();
                    fp.appConfig.Run();
                } );
            }
        );

        </script>
    </head>
    <body>
        <div id="container"></div>
    </body>
</html>
